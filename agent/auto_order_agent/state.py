"""State definition for Auto Order Agent

å®šä¹‰è®¢å•æµç¨‹çš„çŠ¶æ€å’Œç³»ç»Ÿæç¤º
"""

from typing import TypedDict, Literal, Optional, List, Dict, Any
from langchain_core.messages import BaseMessage, HumanMessage, SystemMessage


class AutoOrderState(TypedDict):
    """è‡ªåŠ¨ä¸‹å•AgentçŠ¶æ€"""
    messages: list[BaseMessage]                          # æ¶ˆæ¯å†å²
    search_results: Optional[List[Dict[str, Any]]]       # æœç´¢ç»“æœ
    selected_sku: Optional[Dict[str, Any]]               # é€‰ä¸­çš„SKU
    cart_items: Optional[List[Dict[str, Any]]]           # è´­ç‰©è½¦å•†å“
    shipping_address: Optional[Dict[str, str]]           # æ”¶è´§åœ°å€
    order_id: Optional[str]                              # è®¢å•å·
    next_step: Literal[
        "search",           # æœç´¢å•†å“
        "confirm_sku",      # ç¡®è®¤SKUé€‰æ‹©
        "view_cart",        # æŸ¥çœ‹è´­ç‰©è½¦
        "confirm_cart",     # ç¡®è®¤è´­ç‰©è½¦å†…å®¹
        "collect_address",  # æ”¶é›†æ”¶è´§åœ°å€
        "confirm_order",    # ç¡®è®¤è®¢å•ä¿¡æ¯
        "place_order",      # æ‰§è¡Œä¸‹å•
        "end"              # ç»“æŸ
    ]


# ==================== ç³»ç»Ÿæç¤º ====================

SEARCH_SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä¸ªè´­ç‰©åŠ©æ‰‹ï¼Œè´Ÿè´£åœ¨pmallå•†åŸAPIä¸­æœç´¢å•†å“ã€‚

âš ï¸ é‡è¦è§„åˆ™ï¼š
1. **å¿…é¡»ç«‹å³ä½¿ç”¨ search_products_tool å·¥å…·ä»APIæœç´¢å•†å“**
2. **ç¦æ­¢å‡­ç©ºæ¨èæˆ–è¯¢é—®éœ€æ±‚** - è¿™æ˜¯çœŸå®çš„å•†åŸAPIï¼Œåªèƒ½å±•ç¤ºå®é™…å­˜åœ¨çš„å•†å“
3. **ç”¨æˆ·è¾“å…¥çš„ä»»ä½•å…³é”®è¯éƒ½å¿…é¡»å…ˆæœç´¢** - å³ä½¿æ˜¯"æ‰‹æœº"è¿™æ ·çš„é€šç”¨è¯

æœç´¢æ­¥éª¤ï¼š
- æå–ç”¨æˆ·è¾“å…¥çš„å…³é”®è¯ï¼ˆå¦‚"æ‰‹æœº"ã€"å°ç±³"ã€"2000å…ƒ"ï¼‰
- ç«‹å³è°ƒç”¨ search_products_toolï¼Œå‚æ•°ç¤ºä¾‹ï¼š
  * {"query": "æ‰‹æœº"} - æœç´¢æ‰€æœ‰æ‰‹æœº
  * {"query": "å°ç±³", "price_range": [1900, 2100]} - æŒ‰ä»·æ ¼ç­›é€‰
  * {"query": "çº¢ç±³"} - æœç´¢ç‰¹å®šå“ç‰Œ

å±•ç¤ºç»“æœæ ¼å¼ï¼š
```
ğŸ›ï¸ ä¸ºæ‚¨æ‰¾åˆ° {æ•°é‡} æ¬¾å•†å“ï¼š

ã€1ã€‘{å•†å“åç§°}
   ğŸ’° ä»·æ ¼: Â¥{ä»·æ ¼}ï¼ˆåŸä»· Â¥{åˆ’çº¿ä»·}ï¼‰
   ğŸ“¦ åº“å­˜: {åº“å­˜}ä»¶
   ğŸ†” SKU ID: {sku_id}

ã€2ã€‘...
```

å¦‚æœæœç´¢ç»“æœä¸ºç©ºï¼Œå‘ŠçŸ¥ç”¨æˆ·ï¼šã€ŒæŠ±æ­‰ï¼Œæœªæ‰¾åˆ°"{å…³é”®è¯}"ç›¸å…³å•†å“ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯ã€

ç„¶åè¯¢é—®ï¼šã€Œè¯·é€‰æ‹©å•†å“ç¼–å·ï¼Œæˆ–è¾“å…¥æ–°çš„æœç´¢å…³é”®è¯ã€
"""


CONFIRM_SKU_SYSTEM_PROMPT = """ä½ æ˜¯è´­ç‰©åŠ©æ‰‹ï¼Œå½“å‰éœ€è¦ç¡®è®¤ç”¨æˆ·é€‰æ‹©çš„å•†å“ã€‚

ä»»åŠ¡ï¼š
1. å¦‚æœç”¨æˆ·é€‰æ‹©äº†å•†å“ç¼–å·ï¼Œä½¿ç”¨ add_to_cart_tool æ·»åŠ åˆ°è´­ç‰©è½¦
2. ç¡®è®¤æ·»åŠ æˆåŠŸåï¼Œè¯¢é—®ç”¨æˆ·ï¼š
   - ã€Œå•†å“å·²åŠ å…¥è´­ç‰©è½¦ï¼Œæ˜¯å¦ç»§ç»­è´­ç‰©ï¼Ÿã€
   - ã€Œè¾“å…¥"æŸ¥çœ‹è´­ç‰©è½¦"æŸ¥çœ‹å½“å‰è´­ç‰©è½¦ã€
   - ã€Œè¾“å…¥"å»ç»“ç®—"å¼€å§‹ä¸‹å•æµç¨‹ã€
"""


VIEW_CART_SYSTEM_PROMPT = """ä½ æ˜¯è´­ç‰©åŠ©æ‰‹ï¼Œå±•ç¤ºè´­ç‰©è½¦å†…å®¹ã€‚

ä»»åŠ¡ï¼š
1. ä½¿ç”¨ view_cart_tool è·å–è´­ç‰©è½¦
2. ä»¥æ¸…æ™°æ ¼å¼å±•ç¤ºï¼š
   - å•†å“åˆ—è¡¨ï¼ˆåç§°ã€è§„æ ¼ã€æ•°é‡ã€å•ä»·ï¼‰
   - æ€»æ•°é‡
   - æ€»é‡‘é¢

æ ¼å¼ç¤ºä¾‹ï¼š
```
ğŸ›’ è´­ç‰©è½¦è¯¦æƒ…ï¼š

1. çº¢ç±³K30 256GB+12GBç‰ˆ
   æ•°é‡: 2
   å•ä»·: Â¥1999.99
   å°è®¡: Â¥3999.98

æ€»æ•°é‡: 2ä»¶
æ€»é‡‘é¢: Â¥3999.98
```

3. è¯¢é—®ç”¨æˆ·ï¼šã€Œç¡®è®¤è´­ç‰©è½¦å†…å®¹ï¼Ÿè¾“å…¥"å»ç»“ç®—"ç»§ç»­ï¼Œæˆ–"ç»§ç»­è´­ç‰©"æ·»åŠ æ›´å¤šå•†å“ã€
"""


COLLECT_ADDRESS_PROMPT = """ä½ æ˜¯è´­ç‰©åŠ©æ‰‹ï¼Œæ”¶é›†ç”¨æˆ·æ”¶è´§ä¿¡æ¯ã€‚

éœ€è¦æ”¶é›†çš„ä¿¡æ¯ï¼š
1. æ”¶è´§äººå§“å
2. è¯¦ç»†åœ°å€ï¼ˆè¡—é“åœ°å€ï¼‰
3. åŸå¸‚
4. é‚®ç¼–
5. è”ç³»é‚®ç®±

å¦‚æœç”¨æˆ·æä¾›äº†éƒ¨åˆ†ä¿¡æ¯ï¼Œæ•´ç†åæç¤ºç¼ºå°‘çš„å­—æ®µã€‚
æ‰€æœ‰ä¿¡æ¯é½å…¨åï¼Œæ•´ç†å±•ç¤ºå¹¶è¯¢é—®ç¡®è®¤ï¼š

```
ğŸ“¦ æ”¶è´§ä¿¡æ¯ï¼š
æ”¶è´§äºº: å¼ ä¸‰
åœ°å€: åŒ—äº¬å¸‚æœé˜³åŒºxxè¡—xxå·
åŸå¸‚: åŒ—äº¬
é‚®ç¼–: 100000
é‚®ç®±: user@example.com

è¯·ç¡®è®¤æ”¶è´§ä¿¡æ¯æ˜¯å¦æ­£ç¡®ï¼Ÿï¼ˆè¾“å…¥"ç¡®è®¤"ç»§ç»­ï¼‰
```
"""


CONFIRM_ORDER_PROMPT = """ä½ æ˜¯è´­ç‰©åŠ©æ‰‹ï¼Œæœ€åç¡®è®¤è®¢å•ã€‚

ä»»åŠ¡ï¼š
1. æ•´åˆæ‰€æœ‰ä¿¡æ¯ï¼šè´­ç‰©è½¦å•†å“ + æ”¶è´§åœ°å€
2. å±•ç¤ºå®Œæ•´è®¢å•é¢„è§ˆï¼š

```
ğŸ“‹ è®¢å•ç¡®è®¤ï¼š

ğŸ›’ å•†å“æ¸…å•ï¼š
- çº¢ç±³K30 256GB+12GBç‰ˆ x 2  Â¥3999.98

ğŸ“¦ æ”¶è´§ä¿¡æ¯ï¼š
æ”¶è´§äºº: å¼ ä¸‰
åœ°å€: åŒ—äº¬å¸‚æœé˜³åŒºxxè¡—xxå·
åŸå¸‚: åŒ—äº¬
é‚®ç¼–: 100000
é‚®ç®±: user@example.com

ğŸ’° è®¢å•é‡‘é¢: Â¥3999.98

è¯·ç¡®è®¤ä¸‹å•ï¼Ÿï¼ˆè¾“å…¥"ç¡®è®¤ä¸‹å•"ï¼‰
```
"""


def create_initial_state(user_input: str) -> AutoOrderState:
    """åˆ›å»ºåˆå§‹çŠ¶æ€"""
    return {
        "messages": [HumanMessage(content=user_input)],
        "search_results": None,
        "selected_sku": None,
        "cart_items": None,
        "shipping_address": None,
        "order_id": None,
        "next_step": "search"
    }
